<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏ô 2569</title>
  <link href="https://fonts.googleapis.com/css2?family=Taviraj:wght@400;700&family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-draw/dist/leaflet.draw.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    html, body {
      height: 100%; width: 100%; margin: 0; padding: 0;
      background: linear-gradient(135deg, #e4ffef 0%, #b0ffe1 100%);
      font-family: 'Torsilp ReiyngKhwam', 'Taviraj', 'Noto Sans Thai', sans-serif;
    }
    body {
      min-height: 100vh; min-width: 100vw;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
    }
    .project-title {
      position: sticky;
      top: 0;
      left: 0;
      z-index: 999;
      background: linear-gradient(135deg, #e4ffef 70%, #b0ffe1 100%);
      padding: 10px 0 5px 0;
      width: 100vw;
      font-size: 1.5em;
      color: #217057;
      font-weight: 800;
      text-align: center;
      letter-spacing: 0.01em;
      font-family: inherit;
      text-shadow: 0 1px 5px rgba(30,160,100,0.06);
      margin-bottom: 0;
      border-bottom: 2px solid #c2f5dc;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .project-title img, .project-title svg {
      height: 1.5em;
      margin-right: 8px;
      margin-bottom: 0;
    }
    h1, h2, h3 {
      color: #27604b;
      font-size: 1.15em;
      text-align: center;
      margin-bottom: 1em;
      margin-top: 0.4em;
    }
    .block-title {
      color: #18805d;
      font-size: 1.05em;
      font-weight: bold;
      margin: 14px 0 5px 0;
      letter-spacing: 0.01em;
      text-align: left;
      width: 100%;
      padding-left: 6px;
    }
    .maincenter { width: 100vw; min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 0; margin: 0; margin-top: 200px; }
    .container { display: flex; flex-direction: row; justify-content: center; align-items: flex-start; width: 100vw; gap: 40px; max-width: 1200px; margin-top: 32px; }
    .map-block, .form-block { display: flex; flex-direction: column; align-items: center; background: #dcffee; border-radius: 18px; box-shadow: 0 0 16px 0 rgba(0,0,0,0.08); padding: 20px 0 32px 0; margin-bottom: 16px; min-width: 400px; flex: 1 1 420px; }
    .map-block .block-title { padding-left: 48px; }
     .form-block { background: #fff; box-shadow: 0 4px 16px rgba(40,180,130,0.10); min-width: 350px; max-width: 400px; margin: 48px 0 0 0; align-self: center; justify-content: center; padding: 32px 28px; }
    form { display: flex; flex-direction: column; width: 100%; align-items: center; justify-content: center; }
    label { font-weight: 700; color: #25846e; margin-bottom: 5px; align-self: flex-start; font-size: 1.03em; }
    input, textarea { width: 100%; padding: 12px; margin-bottom: 14px; border: 1px solid #a5ded2; border-radius: 10px; background-color: #f6fffc; font-size: 1em; font-family: inherit; }
    button { background: linear-gradient(90deg,#38b397 40%,#4a6cf7 100%); color: #fff; border: none; padding: 12px; border-radius: 10px; font-weight: 700; font-size: 1.03em; cursor: pointer; margin-top: 8px; transition: background 0.2s; }
    button:hover { background: #2e9187; }
    .note { font-size: 0.98em; color: #51917f; text-align: center; margin-top: 7px; margin-bottom: 0; }
    #map, #map-summary { width: 96%; min-width: 320px; max-width: 600px; height: 440px; border-radius: 15px; box-shadow: 0 0 16px 0 rgba(0,0,0,0.09); margin-bottom: 16px; background: #ebfaf5; margin-left: auto; margin-right: auto; z-index: 10; }
    #responsibleChartBlock { width: 98%; max-width: 640px; background: #eafff3; border-radius: 14px; margin: 18px auto 0 auto; padding: 18px 10px; box-shadow: 0 0 12px 0 rgba(0,0,0,0.06); display: flex; flex-direction: column; align-items: center; }
    #responsibleChart { max-width: 580px; width: 100%; height: 340px; }
    #summary-section { margin-top: 35px; width: 100%; max-width: 1200px; }
    @media (max-width: 1000px) { .container { flex-direction: column; align-items: center; gap: 0; } .form-block, .map-block { min-width: 90vw; max-width: 98vw; } #map, #map-summary, #responsibleChartBlock { min-width: 220px; width: 98vw; } .project-title { font-size: 1em; padding: 8px 0 4px 0; } }
  </style>
</head>
<body>
  <div class="project-title">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36" width="36" height="36"><rect x="1" y="25" width="34" height="7" rx="1.8" fill="#ffd93b" stroke="#b28908" stroke-width="1.5"/><rect x="6" y="9" width="24" height="16" rx="2.5" fill="#fff" stroke="#85928b" stroke-width="1.4"/><rect x="7.5" y="11.5" width="6" height="5" rx="1" fill="#58cc02"/><rect x="15" y="11.5" width="6" height="5" rx="1" fill="#fa5667"/><rect x="22.5" y="11.5" width="6" height="5" rx="1" fill="#4a6cf7"/></svg>
    <span><b>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏ô (Road Project 2569)</b></span>
  </div>
  <div class="maincenter">
    <div class="container">
      <div class="map-block">
        <div class="block-title">üó∫Ô∏è ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏∏‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</div>
        <div id="map"></div>
        <div id="responsibleChartBlock">
          <b>‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</b>
          <canvas id="responsibleChart"></canvas>
        </div>
      </div>
      <div class="form-block">
        <div class="block-title">üìã ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ñ‡∏ô‡∏ô</div>
        <form id="roadForm" onsubmit="return submitToScript(event)">
          <label for="project_name">‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£</label>
          <input type="text" id="project_name" required>
          <label for="budget">‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
          <input type="text" id="budget" required>
          <label for="duration">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <input type="text" id="duration" required>
          <label for="details">‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£</label>
          <textarea id="details" rows="3" required></textarea>
          <label for="responsible">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</label>
          <input type="text" id="responsible" required>
          <input type="hidden" id="polyline_data">
          <button type="submit">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <div class="note">* ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á</div>
        </form>
      </div>
    </div>
    <div id="summary-section">
      <h2>üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß</h2>
      <div class="map-block"><div id="map-summary"></div></div>
    </div>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-draw/dist/leaflet.draw.js"></script>
  <script>
    // MAP INPUT (‡∏ã‡πâ‡∏≤‡∏¢)
    let map, drawnItems;
    window.addEventListener('DOMContentLoaded', function() {
      map = L.map('map').setView([13.736717, 100.523186], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
      drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);
      new L.Control.Draw({
        edit: { featureGroup: drawnItems },
        draw: { polyline: true, marker: true, polygon: false, rectangle: false, circle: false, circlemarker: false }
      }).addTo(map);
      map.on(L.Draw.Event.CREATED, e => {
        drawnItems.clearLayers();
        const layer = e.layer;
        drawnItems.addLayer(layer);
        let coords = [];
        if (layer instanceof L.Polyline) {
          coords = layer.getLatLngs().map(p => [p.lat, p.lng]);
        } else if (layer instanceof L.Marker) {
          const p = layer.getLatLng();
          coords = [[p.lat, p.lng]];
        }
        document.getElementById('polyline_data').value = JSON.stringify(coords);
      });
      loadProjectsFromSheet();
    });
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Apps Script
    function submitToScript(e) {
      e.preventDefault();
      const polyline = document.getElementById('polyline_data').value.trim();
      let coords = [];
      try { coords = JSON.parse(polyline); } catch {}
      const isValid = Array.isArray(coords) && coords.length > 0 && Array.isArray(coords[0]) && coords[0].length === 2;
      if (!isValid) {
        alert("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        return false;
      }
      const params = new URLSearchParams({
        project_name: document.getElementById('project_name').value,
        budget: document.getElementById('budget').value,
        duration: document.getElementById('duration').value,
        details: document.getElementById('details').value,
        responsible: document.getElementById('responsible').value,
        polyline: polyline
      });
      fetch("https://script.google.com/macros/s/AKfycbyOGBZrW89OuYEJ88jKK6PlhQp4oi2mnjV8sxJAY2rZfazs_OQttiRQ7dMr_NAbUev4/exec?" + params.toString())
        .then(res => res.ok ? res.json() : Promise.reject(res.statusText))
        .then(data => {
          alert("‚úÖ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
          document.getElementById("roadForm").reset();
          document.getElementById("polyline_data").value = "";
          drawnItems.clearLayers();
          loadProjectsFromSheet();
        })
        .catch(err => alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err));
      return false;
    }
    // MAP SUMMARY (‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á)
    let mapSummary, chart;
    function loadProjectsFromSheet() {
      const sheetID = '14oqcYqvQHVJC9imxYVhalvS767GLoXrCdgXxQM6ciTs';
      const url = `https://opensheet.elk.sh/${sheetID}/Sheet1`;
      // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà
      if (mapSummary) mapSummary.remove();
      mapSummary = L.map('map-summary').setView([13.736717, 100.523186], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(mapSummary);
      fetch(url)
        .then(res => res.json())
        .then(rows => {
          // ‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ô map-summary
          rows.forEach(row => {
            if (!row.polyline) return;
            try {
              const coords = JSON.parse(row.polyline);
              const latlngs = coords.map(c => L.latLng(c[0], c[1]));
              let shape;
              if (latlngs.length === 1) {
                shape = L.marker(latlngs[0]);
              } else {
                shape = L.polyline(latlngs, { color: 'deeppink', weight: 5 });
              }
              const popup = `<b>${row.project_name}</b><br>‡∏ß‡∏á‡πÄ‡∏á‡∏¥‡∏ô: ${row.budget}<br>‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£: ${row.details}`;
              shape.bindPopup(popup).addTo(mapSummary);
            } catch (e) {
              console.error('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ parse polyline ‡πÑ‡∏î‡πâ:', row.polyline);
            }
          });

          // ===== ‡∏Å‡∏£‡∏≤‡∏ü‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö =====
          const responsibleCounts = {};
          rows.forEach(row => {
            const resp = (row.responsible || '').trim();
            if (!resp) return;
            responsibleCounts[resp] = (responsibleCounts[resp] || 0) + 1;
          });
          const sortedNames = Object.keys(responsibleCounts).sort((a, b) => responsibleCounts[b] - responsibleCounts[a]);
          const labels = sortedNames;
          const data = sortedNames.map(name => responsibleCounts[name]);

          if (chart) chart.destroy();
          chart = new Chart(document.getElementById('responsibleChart').getContext('2d'), {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£',
                data: data,
                backgroundColor: 'rgba(56,179,151,0.7)',
                borderColor: 'rgba(40,128,120,0.9)',
                borderWidth: 1,
                borderRadius: 8,
                barPercentage: 0.7,
                categoryPercentage: 0.6
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: false },
                title: { display: false }
              },
              scales: {
                y: { beginAtZero: true, ticks: { precision:0 } },
                x: { ticks: { font: { weight: 'bold' }}}
              }
            }
          });
        });
    }
  </script>
</body>
</html>
